<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
  <title>Student Portal ‚Äì Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { background: linear-gradient(145deg, #f0f4ff 0%, #e6edfa 100%); min-height: 100vh; }
    .glass-card { background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 20px 35px -10px rgba(0,0,0,0.1); }
    .lang-toggle { transition: all 0.2s; }
    /* 3-dot loading animation */
    .loading-dots {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .loading-dots span {
      width: 10px;
      height: 10px;
      background: #3b82f6;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
  </style>
</head>
<body class="font-sans antialiased flex items-center justify-center p-4">
  <div class="glass-card w-full max-w-4xl rounded-3xl p-8">
    <!-- Header with language toggle -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-700 bg-clip-text text-transparent" data-i18n="appTitle">üìò Student Portal</h1>
      <div class="flex space-x-2">
        <button onclick="setLanguage('en')" class="lang-toggle px-3 py-1 bg-white/80 text-blue-800 rounded-full text-sm font-medium shadow-sm hover:shadow">EN</button>
        <button onclick="setLanguage('hi')" class="lang-toggle px-3 py-1 bg-white/80 text-indigo-800 rounded-full text-sm font-medium shadow-sm hover:shadow">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
      </div>
    </div>

    <!-- ========== LOGIN / REGISTER PANEL (shown when not logged in) ========== -->
    <div id="authContainer">
      <!-- Login Form -->
      <div id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="studentId">Student ID</label>
          <input type="text" id="studentId" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white/70" placeholder="e.g. 2024CS001">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="dob">Date of Birth (DDMMYY)</label>
          <input type="text" id="dob" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white/70" placeholder="010105" maxlength="6">
        </div>
        <button onclick="handleLogin()" id="loginBtn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-semibold py-3 px-4 rounded-xl transition duration-200 flex items-center justify-center gap-2 shadow-lg">
          <span data-i18n="login">Login</span>
        </button>
        <div class="text-center text-sm text-gray-600">
          <span data-i18n="noAccount">Don't have an account?</span>
          <a href="#" onclick="showRegister()" class="text-blue-600 hover:underline font-medium" data-i18n="registerHere">Register here</a>
        </div>
      </div>
      <!-- Register Form -->
      <div id="registerForm" class="space-y-4 hidden">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="fullName">Full Name</label>
          <input type="text" id="regName" class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-white/70">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="studentId">Student ID</label>
          <input type="text" id="regId" class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-white/70">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="dob">Date of Birth (DDMMYY)</label>
          <input type="text" id="regDob" class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-white/70" maxlength="6">
        </div>
        <button onclick="handleRegister()" id="registerBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-3 px-4 rounded-xl transition shadow-lg flex items-center justify-center gap-2">
          <span data-i18n="register">Register</span>
        </button>
        <div class="text-center text-sm">
          <a href="#" onclick="showLogin()" class="text-gray-600 hover:underline" data-i18n="backToLogin">‚Üê Back to login</a>
        </div>
      </div>
    </div>

    <!-- ========== DASHBOARD (shown after login) ========== -->
    <div id="dashboardContainer" class="hidden space-y-6">
      <!-- Student Info Card -->
      <div class="bg-white/60 rounded-2xl p-6 border border-white/30">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-3xl text-blue-600">
            <i class="fas fa-user-graduate"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gray-800" id="studentNameDisplay"></h2>
            <p class="text-gray-600" id="studentIdDisplay"></p>
            <p class="text-sm text-gray-500" id="studentDobDisplay"></p>
          </div>
          <button onclick="logout()" class="ml-auto btn-secondary px-4 py-2 rounded-full border border-gray-300 hover:bg-gray-100 flex items-center gap-2">
            <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span>
          </button>
        </div>
      </div>

      <!-- Available Tests -->
      <div class="bg-white/60 rounded-2xl p-6 border border-white/30">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><i class="fas fa-pencil-alt text-blue-600"></i> <span data-i18n="availableTests">Available Tests</span></h3>
        <div id="availableTestsList" class="space-y-3">
          <!-- dynamic content -->
          <div class="flex justify-center py-8">
            <div class="loading-dots"><span></span><span></span><span></span></div>
          </div>
        </div>
      </div>

      <!-- Previous Results -->
      <div class="bg-white/60 rounded-2xl p-6 border border-white/30">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><i class="fas fa-history text-indigo-600"></i> <span data-i18n="previousResults">Previous Test Results</span></h3>
        <div id="previousResultsList" class="overflow-x-auto">
          <!-- dynamic table -->
          <div class="flex justify-center py-8">
            <div class="loading-dots"><span></span><span></span><span></span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Global Message / Toast -->
    <div id="message" class="mt-4 text-sm text-center hidden p-3 rounded-xl"></div>
  </div>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxO2mwGcAx-lB9NylCldAjLkV7F6Dpk1V-0LmeteMG8VGx5AiCKZQeaxkBHK0EUotk/exec'; // <-- PASTE YOUR WEB APP URL
    const translations = {
      en: {
        appTitle: 'üìò Student Portal', studentId: 'Student ID', dob: 'Date of Birth (DDMMYY)',
        login: 'Login', noAccount: "Don't have an account?", registerHere: 'Register here',
        fullName: 'Full Name', register: 'Register', backToLogin: '‚Üê Back to login',
        logout: 'Logout', availableTests: 'Available Tests', previousResults: 'Previous Test Results',
        startTest: 'Start Test', testName: 'Test Name', duration: 'Duration', score: 'Score',
        rank: 'Rank', submitted: 'Submitted', noTests: 'No tests available.', noResults: 'No previous results.'
      },
      hi: {
        appTitle: 'üìò ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤', studentId: '‡§õ‡§æ‡§§‡•ç‡§∞ ‡§Ü‡§à‡§°‡•Ä', dob: '‡§ú‡§®‡•ç‡§Æ ‡§§‡§ø‡§•‡§ø (DDMMYY)',
        login: '‡§≤‡•â‡§ó ‡§á‡§®', noAccount: '‡§ñ‡§æ‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à?', registerHere: '‡§Ø‡§π‡§æ‡§Å ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§ï‡§∞‡•á‡§Ç',
        fullName: '‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ', register: '‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£', backToLogin: '‚Üê ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Å',
        logout: '‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü', availableTests: '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ‡§è‡§Å', previousResults: '‡§™‡§ø‡§õ‡§≤‡•á ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ',
        startTest: '‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç', testName: '‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§®‡§æ‡§Æ', duration: '‡§Ö‡§µ‡§ß‡§ø', score: '‡§Ö‡§Ç‡§ï',
        rank: '‡§∞‡•à‡§Ç‡§ï', submitted: '‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§§‡§ø‡§•‡§ø', noTests: '‡§ï‡•ã‡§à ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç‡•§', noResults: '‡§ï‡•ã‡§à ‡§™‡§ø‡§õ‡§≤‡§æ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç‡•§'
      }
    };
    let currentLang = 'en';
    let studentToken = localStorage.getItem('studentToken');
    let studentInfo = null;

    // ---------- I18N ----------
    function setLanguage(lang) {
      currentLang = lang;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (translations[lang]?.[key]) {
          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = translations[lang][key];
          else el.innerText = translations[lang][key];
        }
      });
    }

    // ---------- UI Helpers ----------
    function showLoading(btn) {
      btn.disabled = true;
      btn.innerHTML = `<div class="loading-dots"><span></span><span></span><span></span></div>`;
    }
    function hideLoading(btn, originalText) {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
    function showMessage(msg, isError = false) {
      const msgDiv = document.getElementById('message');
      msgDiv.classList.remove('hidden');
      msgDiv.className = `mt-4 text-sm text-center p-3 rounded-xl ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
      msgDiv.innerText = msg;
      setTimeout(() => msgDiv.classList.add('hidden'), 4000);
    }

    // ---------- Authentication ----------
    window.onload = function() {
      setLanguage('en');
      if (studentToken) {
        // auto-login and show dashboard
        document.getElementById('authContainer').classList.add('hidden');
        document.getElementById('dashboardContainer').classList.remove('hidden');
        loadDashboard();
      }
    };

    async function handleLogin() {
      const id = document.getElementById('studentId').value.trim();
      const dob = document.getElementById('dob').value.trim();
      if (!id || !dob) return showMessage('Fill all fields', true);
      const btn = document.getElementById('loginBtn');
      const original = btn.innerHTML;
      showLoading(btn);
      try {
        const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', id, dob }) });
        const data = await res.json();
        if (data.status === 'success') {
          localStorage.setItem('studentToken', data.token);
          localStorage.setItem('studentName', data.data.name);
          localStorage.setItem('studentId', data.data.id);
          studentToken = data.token;
          document.getElementById('authContainer').classList.add('hidden');
          document.getElementById('dashboardContainer').classList.remove('hidden');
          loadDashboard();
        } else showMessage(data.data, true);
      } catch(e) { showMessage(e.message, true); }
      hideLoading(btn, original);
    }

    async function handleRegister() {
      const name = document.getElementById('regName').value.trim();
      const id = document.getElementById('regId').value.trim();
      const dob = document.getElementById('regDob').value.trim();
      if (!name || !id || !dob) return showMessage('Fill all fields', true);
      const btn = document.getElementById('registerBtn');
      const original = btn.innerHTML;
      showLoading(btn);
      try {
        const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'register', id, name, dob }) });
        const data = await res.json();
        if (data.status === 'success') {
          showMessage('Registration successful! Please login.');
          showLogin();
        } else showMessage(data.data, true);
      } catch(e) { showMessage(e.message, true); }
      hideLoading(btn, original);
    }

    function logout() {
      localStorage.removeItem('studentToken');
      localStorage.removeItem('studentName');
      localStorage.removeItem('studentId');
      studentToken = null;
      document.getElementById('dashboardContainer').classList.add('hidden');
      document.getElementById('authContainer').classList.remove('hidden');
      showLogin();
    }

    function showRegister() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
    }
    function showLogin() {
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    // ---------- DASHBOARD ----------
    async function loadDashboard() {
      // show loading states
      document.getElementById('availableTestsList').innerHTML = '<div class="flex justify-center py-8"><div class="loading-dots"><span></span><span></span><span></span></div></div>';
      document.getElementById('previousResultsList').innerHTML = '<div class="flex justify-center py-8"><div class="loading-dots"><span></span><span></span><span></span></div></div>';
      
      // fetch student info
      try {
        const infoRes = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getStudentDashboard', token: studentToken }) });
        const infoData = await infoRes.json();
        if (infoData.status === 'success') {
          studentInfo = infoData.data;
          document.getElementById('studentNameDisplay').innerText = studentInfo.name;
          document.getElementById('studentIdDisplay').innerText = `ID: ${studentInfo.id}`;
          document.getElementById('studentDobDisplay').innerText = `DOB: ${studentInfo.dob}`;
        }
      } catch(e) { console.error(e); }

      // load available tests
      try {
        const testsRes = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAvailableTests', token: studentToken }) });
        const testsData = await testsRes.json();
        if (testsData.status === 'success') {
          let html = '';
          if (testsData.data.length === 0) {
            html = `<p class="text-gray-500 text-center py-4" data-i18n="noTests">${translations[currentLang].noTests}</p>`;
          } else {
            testsData.data.forEach(test => {
              html += `<div class="flex items-center justify-between bg-white/70 p-4 rounded-xl border border-gray-100">
                <div>
                  <h4 class="font-semibold">${test.testName}</h4>
                  <p class="text-sm text-gray-600">${test.duration} min | +${test.correctMarks} / -${test.wrongMarks} / 0:${test.skipMarks}</p>
                </div>
                <button onclick="startTest('${test.testId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full text-sm font-medium shadow-md transition flex items-center gap-2">
                  <i class="fas fa-play"></i> <span data-i18n="startTest">Start Test</span>
                </button>
              </div>`;
            });
          }
          document.getElementById('availableTestsList').innerHTML = html;
        }
      } catch(e) { console.error(e); }

      // load previous results
      try {
        const resultsRes = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getStudentResults', token: studentToken }) });
        const resultsData = await resultsRes.json();
        if (resultsData.status === 'success') {
          let html = '';
          if (resultsData.data.length === 0) {
            html = `<p class="text-gray-500 text-center py-4" data-i18n="noResults">${translations[currentLang].noResults}</p>`;
          } else {
            html = `<table class="w-full text-sm">
              <thead class="bg-gray-100 text-gray-700">
                <tr><th class="p-2 text-left">${translations[currentLang].testName}</th><th class="p-2 text-left">${translations[currentLang].score}</th><th class="p-2 text-left">${translations[currentLang].rank}</th><th class="p-2 text-left">${translations[currentLang].submitted}</th></tr>
              </thead>
              <tbody>`;
            resultsData.data.forEach(r => {
              html += `<tr class="border-b">
                <td class="p-2">${r.testName}</td>
                <td class="p-2 font-semibold">${r.score}</td>
                <td class="p-2">#${r.rank}</td>
                <td class="p-2 text-gray-500">${new Date(r.submitted).toLocaleDateString()}</td>
              </tr>`;
            });
            html += `</tbody></table>`;
          }
          document.getElementById('previousResultsList').innerHTML = html;
        }
      } catch(e) { console.error(e); }
    }

    function startTest(testId) {
      window.location.href = `test.html?testId=${testId}`;
    }
  </script>
</body>
</html>
